% doctestのインストールと使い方
% Morita Yasuaki
% Feb 20, 2013

テストやドキュメンテーションに
**doctest**が便利なので紹介します。

cabal、doctestのインストール設定等
====================================

まず**cabal**を新しくする！(重要)
**cabal**はパッケージ管理ソフトです。
ただ、結構融通の効かないやつです。

+ パッケージのアンインストール機能がない
+ 変なキャッシュやログが残ると手で処理してあげないといけない
+ パッケージ依存関係が一回おかしくなるとヤバい


さて、まずはこの**cabal**やっつけなければなりません。
haskell-platformは入ってるとして、

~~~~
$ cabal install cabal-install
~~~~

と打ちましょう。


このコマンドはなんなんだという感じですね。


haskell-platformに元から入ってるcabalで
新しめのcabalをインストールするという意味です。
なのであなたのPCにはcabalが二つ入ります。
cabal-devというプロジェクト毎に
パッケージを管理するやつもあるので好みで使ってください。

僕は時間もかかるし、容量も食うので、
cabalでどっからでも使えるようにしちゃってます。
(地雷っぽいパッケージはcabal-devでやる時もあります)

インストールが終わったら


~~~~
$ which cabal
~~~~


でcabalの所在地を調べましょう。
もしホームディレクトリ以下($HOME/.cabal/bin/cabal)
でなければ、古いcabalが使われているままです。
PATHをゴニョゴニョして、新しいcabalが優先して使われるようにしておきます。

~~~~
export PATH=$HOME/.cabal/bin:$PATH
~~~~


で、早速doctestをインストール。。。する前に
いちおう

~~~~
cabal update
~~~~

でパッケージ情報を最新にしておきます。


あと、cabal初回起動時に**$HOME/.cabal/config**というファイルが作られるのですが、
自分好みに中身を書き換えた方がいいかも知れません。
僕はなんとなくdocumentation=Trueにしています。
(デフォルトドでキュメント付きでパッケージインストールするの意味)


~~~~
cabal install doctest-prop
~~~~

とやればdoctest-propが入る。。。はずです！
（覚えてない）
すんなりいかなくても
cabalの吐くメッセージとか読んで、
依存パッケージのインストールとかやっていけば大丈夫だと思います。


cabalで何も考えずにインストールしたパッケージは、
さっきPATHを通した$HOME/.cabal/binに配置されるので
すぐ使えると思います。

開発環境整える系では

+ ghc-mod
+ haddock
+ HLint

あたりを追加で入れとくといいかも知れません。
僕はlintはあんまり使ってないですが、
ghc-modにはお世話になっています。

doctest (doctest-prop) haddock の使い方
=======================================

doctestというのは元々pythonが発祥らしく、
コメントにある書式でテストケースを書いとくと
テスト実行ができて、
なおかつドキュメンテーションとしても残せる
という仕組みのやつです。


+ コメントの最初に`|`を書くと、その下にある関数のドキュメンテーションになる
+ コメントの最初に`^`を書くと、その上にある関数のドキュメンテーションになる
+ `>>>`を書くと実行例、次の行が予期される結果を意味します(doctestでユニットテストできます)
+ `prop>`を書くと性質(任意の整数に対して成り立つみたいなの)を表します(doctestでQuick Checkが走ります)

`>>>`の方はghciで実行した結果と文字列比較するだけのものなので
例外でもテストできます。

テストケースの書き方はだいたいこんな感じです。
~~~~

-- |
-- doubleのテストケースだよ
-- >>> double 4
-- 8

double :: Int -> Int
double a = 2*a

-- ^
-- doubleの他の利用例
-- >>> double 12
-- 24
-- double関数の性質
-- prop> double x `div` 2 = x

~~~~

テストしたい時は

~~~~
doctest *.hs
~~~~

とかやるとテストケースの実行ができます。

~~~~
haddock --html *.hs -o doc
~~~~

でdoc以下にドキュメントが生成されます。
この辺はhelpを読むなりして使いこなしてください。

僕の使い方と使い心地の感想
==========================

脅威のVimテクノロジ+Quick Runプラグインで
2キーストロークで現在編集中のファイルにdoctestが走るようにしています。
コンパイラのショートカット起動をdoctestに置き換えてる感じです。

+ コンパイルが通らない時はコンパイルエラーが出力される
+ 書式が単純でかなり気軽にテストケースが書ける
+ ちょっとした実験にも使える(エディタとghciを行ったり来たりせずに実験)

とくに勉強会の演習問題とかは非常にはかどります。


> 実験と実装とテストの間を行来するハードルが非常に低くなり、
> 個人的にはとても便利、快適になりました。
